<html>

<head>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    .barchart {
      position: center;
      background-color: #80d7ec;
    }

    .hidden {
      display: none;
    }

    .tooltip {
      color: #222;
      background: #fff;
      border-radius: 3px;
      box-shadow: 0px 0px 2px 0px #a6a6a6;
      padding: .2em;
      text-shadow: #f5f5f5 0 1px 0;
      opacity: 0.9;
      position: absolute;
    }

    .state {
      fill: none;
    }

    .container {
      background-color: #120458;
    }

    .devlist {
      overflow: auto;
    }

    .devlist::-webkit-scrollbar {
      background-color: #005678;
    }

    .devlist::-webkit-scrollbar-thumb {
      background-color: #65dc98;
    }

    .devlist li {
      list-style-type: "\1F579";
      font-family: 'Courier New', monospace;
      font-weight: bolder;
      color: #65dc98;
    }

    .gamelist {
      overflow: auto;
    }

    .gamelist::-webkit-scrollbar {
      background-color: #005678;
    }

    .gamelist::-webkit-scrollbar-thumb {
      background-color: #65dc98;
    }

    .gamelist li {
      list-style-type: "\1F3AE";
      font-family: 'Courier New', monospace;
      font-weight: bolder;
      color: #65dc98;
    }
  </style>
</head>

<body>
  <p>
    <!-- <svg id="choropleth" height="700" width="1000" style="margin:20px"></svg> -->

    <!-- <div class="tooltip" style="display:flex">

    <div id="devlist" class="devlist" style="height: 800px; width: 200px; flex-grow:1">

    </div>

    <div id="gamelist" class="gamelist" style="height: 800px; width: 200px; flex-grow:1">

    </div>

  </div> -->

    <svg id='barchart' class='barchart' height="700" width="1000">
    </svg>

    <script>

      // const svg = d3.select("#choropleth");
      // const width = svg.attr("width");
      // const height = svg.attr("height");
      // const margin = { top: 20, right: 20, bottom: 20, left: 20 };
      // const mapWidth = width - margin.left - margin.right;
      // const mapHeight = height - margin.top - margin.bottom;
      // const map = svg.append("g")
      //   .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // const devlist = d3.select("#devlist")
      // const developers = devlist.append("ul")

      // const gamelist = d3.select("#gamelist")
      // const games = gamelist.append("ul").attr("id", "games")

      const barchart = d3.select('#barchart')
      const barWidth = barchart.attr("width");
      const barHeight = barchart.attr("height");
      const barMargins = { top: 20, right: 20, bottom: 20, left: 20 };
      const chartWidth = barWidth - barMargins.left - barMargins.right;
      const chartHeight = barHeight - barMargins.top - barMargins.bottom;

      console.log(chartWidth, chartHeight)

      let chartArea = barchart.append("g")
        .attr("transform", "translate(" + barMargins.left + "," + barMargins.top + ")");

      const requestData = async function () {

        const dev = await d3.csv("vg_dev.csv");
        const sales = await d3.csv("vg_sales.csv");
        const ratings = await d3.csv("user_ratings.csv");

        console.log(ratings)

        let xbox = ratings.filter(x => x['console'] == 'XBOX').slice(0, 5).sort(function (a, b) {
          return b.metascore - a.metascore
        })
        let ps3 = ratings.filter(x => x['console'] == 'PS3').slice(0, 5).sort(function (a, b) {
          return b.metascore - a.metascore
        })
        let wii = ratings.filter(x => x['console'] == 'WII').slice(0, 5).sort(function (a, b) {
          return b.metascore - a.metascore
        })


        console.log(xbox)
        console.log(ps3)
        console.log(wii)

        const bardata = xbox.concat(ps3, wii)

        const scoreScale = d3.scaleLinear()
          .domain([0, 100])
          .range([0, chartWidth - 200]);

        const names = d3.map(bardata, d => d.name)

        const nameScale = d3.scaleBand()
          .range([0, chartHeight])
          .domain(names)
          .padding(.1);

        let leftAxis = d3.axisLeft(nameScale)

        barchart.append("g")
          .attr("class", "y axis")
          .attr("transform", `translate(200, 20)`)
          .call(leftAxis)

        let bottomAxis = d3.axisBottom(scoreScale)
        barchart.append("g")
          .attr("class", "x axis")
          .attr("transform", `translate(200, 680)`)
          .call(bottomAxis)


        barchart.selectAll("myRect")
          .data(bardata)
          .enter()
          .append("rect")
          .attr("x", scoreScale(0) + 200)
          // .attr("x", 300)
          .attr("y", d => nameScale(d.name) + 30)
          // .attr("y", 300)
          .attr("width", d => scoreScale(d.metascore))
          // .attr("width", 300)
          .attr("height", d => 24)
          .attr("fill", d => colorfill(d.console))

        function colorfill(console) {
          if (console == 'XBOX') {
            return "white"
          }
          else if (console == 'PS3') {
            return "black"
          }
          else return "yellow"

        }


        // const world = await d3.json('https://unpkg.com/world-atlas@1.1.4/world/110m.json');

        // const percentScale = d3.scaleLinear().domain([0, 100]).range([chartHeight, 0]);
        // var country_sales = ["North America", "European Union", "Japan", "Global"];
        // const countries = d3.map(sales, d => country_sales);
        // console.log(countries);
        // var projection = d3.geoNaturalEarth1()
        //   .center([0, 15])
        //   .rotate([-9, 0])
        //   .scale([1300 / (2 * Math.PI)])
        //   .translate([450, 300]);

        // var path = d3.geoPath()
        //   .projection(projection);

        // var tooltip = d3.select("div.tooltip");

        // var countries1 = topojson.feature(world, world.objects.countries).features;

        // countries = countries1.filter(function (d) {
        //   return names.some(function (n) {
        //     if (d.id == n.id) return d.name = n.name;
        //   })
        // });

        // let devCounts = {};

        // dev.forEach(row => {
        //   if (devCounts[row.Country]) {
        //     devCounts[row.Country] += 1;
        //   }
        //   else {
        //     devCounts[row.Country] = 1;
        //   }
        // });
        // console.log(devCounts)


        // count = []
        // for (var key in devCounts) {
        //   count.push(devCounts[key])
        // }
        // console.log(count)


        // var divergentScale = [
        //   "rgb(222, 222, 222)", "rgb(124, 159, 224)", "rgb(4, 12, 80)"]

        // const colorScale = d3.scaleQuantile()
        //   .domain(count)
        //   .range(divergentScale)

        // svg.selectAll("path")
        //   .data(countries)
        //   .enter()
        //   .append("path")
        //   .attr("stroke", "green")
        //   .attr("stroke-width", 1)
        //   .attr("fill", "white")
        //   .attr("d", path)
        //   .style("fill", d => colorScale(devCounts[d.name]))
        //   .on("mouseover", function (d, i) {
        //     d3.select(this).attr("fill", "grey").attr("stroke-width", 2);
        //     return tooltip.style("hidden", false).html(filter_dev(i.name));
        //   })
        //   .on("mouseout", function (d, i) {
        //     d3.select(this).attr("fill", "white").attr("stroke-width", 1);
        //     tooltip.classed("hidden", true);
        //   });

        // function filter_dev(country_name) {
        //   dev1 = dev.filter(x => x.Country == country_name)
        //   res = dev1.map(x => x.Developer)
        //   console.log(res)
        //   return res
        // }

        //TODO:Modify this to only display the developers that match country chosen
        // dev.forEach(d => {
        //   developers.append('li')
        //     .append('span')
        //     .attr('id', d.Developer)
        //     .text(d.Developer)
        //     .on("click", function () {
        //       document.getElementById('games').innerHTML = "";
        //       let element = d3.select(this);
        //       let result = sales.filter(pub => pub.Publisher === element.attr('id'));
        //       if (result.length === 0) {
        //         games.append('text')
        //           .text("No Data Available :(")
        //           .style("font-family", "Courier New, monospace")
        //           .style("font-weight", "bolder")
        //           .style("color", "#65dc98")
        //           .style("text-align", "center")
        //       } else {

        //         result.forEach(pub => {

        //           games.append('li')
        //             .append('span')
        //             .attr('id', pub.Name)
        //             .text(pub.Name)
        //             .style('margin-left', 5)

        //             //TODO:add an on click feature to show the barcharts of game sales
        //             .on("click", function () {

        //             })
        //         })
        //       }
        //     })
        // });





      };

      requestData();

    </script>


</body>

</html>